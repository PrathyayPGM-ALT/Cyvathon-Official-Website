<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cybucks Banking System</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0d0d0d;
      color: #fff;
      padding: 20px;
    }
    .container {
      max-width: 450px;
      margin: auto;
      background: #1a1a1a;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.6);
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
      border: none;
      font-size: 14px;
    }
    input, select {
      background: #111;
      color: #fff;
      box-sizing: border-box;
    }
    button {
      background: #00b894;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      background: #019371;
    }
    h2 {
      text-align: center;
    }
    label {
      display: block;
      margin-top: 15px;
      font-size: 13px;
      opacity: 0.9;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>Cybucks Banking System</h2>

    <!-- LOGIN BOX -->
    <div id="loginBox">
      <input id="username" placeholder="Username">
      <input id="password" type="password" placeholder="Password">
      <button onclick="login()">Login / Register</button>
    </div>

    <!-- BANK SYSTEM -->
    <div id="bankBox" style="display:none;">
      <h3>Welcome, <span id="userDisplay"></span></h3>
      <p>Your Balance: <b id="balance">0</b> Cybucks</p>

      <label for="userSelect">Send to user:</label>
      <select id="userSelect">
        <!-- options filled by JS -->
      </select>

      <label for="amount">Amount to send:</label>
      <input id="amount" type="number" min="1" placeholder="Amount">

      <button onclick="sendMoney()">Send Cybucks</button>
    </div>
  </div>

<script>
const API_BASE = ""; // same origin as /bank
let currentUser = null;

// POST helper
async function postJSON(path, bodyObj) {
  const res = await fetch(`${API_BASE}${path}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(bodyObj)
  });

  const data = await res.json().catch(() => ({}));
  if (!res.ok || !data.success) {
    const msg = data.error || `Request failed with status ${res.status}`;
    throw new Error(msg);
  }
  return data;
}

// GET helper
async function getJSON(path) {
  const res = await fetch(`${API_BASE}${path}`);
  const data = await res.json().catch(() => ({}));
  if (!res.ok || !data.success) {
    const msg = data.error || `Request failed with status ${res.status}`;
    throw new Error(msg);
  }
  return data;
}

// LOGIN FUNCTION
async function login() {
  try {
    const user = document.getElementById("username").value.trim();
    const pass = document.getElementById("password").value;

    if (!user || !pass) {
      alert("Fill all fields");
      return;
    }

    const data = await postJSON("/login", {
      username: user,
      password: pass
    });

    currentUser = user;
    document.getElementById("userDisplay").innerText = user;
    document.getElementById("balance").innerText = data.balance;

    document.getElementById("loginBox").style.display = "none";
    document.getElementById("bankBox").style.display = "block";

    await loadUsers();
  } catch (err) {
    console.error(err);
    alert("Login failed: " + err.message);
  }
}

// LOAD USERS INTO DROPDOWN
async function loadUsers() {
  try {
    const data = await getJSON("/users");
    const select = document.getElementById("userSelect");
    select.innerHTML = "";

    const users = data.users || [];

    users
      .filter(u => u.username !== currentUser) // do not show yourself
      .forEach(u => {
        const opt = document.createElement("option");
        opt.value = u.username;
        opt.textContent = `${u.username} (${u.balance} CB)`;
        select.appendChild(opt);
      });

    // If no other users exist
    if (select.options.length === 0) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "No other users yet";
      select.appendChild(opt);
    }
  } catch (err) {
    console.error(err);
    alert("Could not load users: " + err.message);
  }
}

// SEND CYBUCKS
async function sendMoney() {
  try {
    const toUser = document.getElementById("userSelect").value;
    const amount = parseInt(document.getElementById("amount").value, 10);

    if (!toUser) {
      alert("Pick a user to send to");
      return;
    }

    if (!amount || amount <= 0) {
      alert("Enter a positive amount");
      return;
    }

    const data = await postJSON("/transfer", {
      from_username: currentUser,
      to_username: toUser,
      amount: amount
    });

    // Update your own balance
    document.getElementById("balance").innerText = data.balance;
    document.getElementById("amount").value = "";

    // Refresh dropdown balances
    await loadUsers();

    alert(`Sent ${amount} Cybucks to ${toUser}!`);
  } catch (err) {
    console.error(err);
    alert("Transfer failed: " + err.message);
  }
}
</script>

</body>
</html>
